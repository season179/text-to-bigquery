# BigQuery Text-to-SQL Microservice: Task Plan

This document outlines the tasks and subtasks required to develop the BigQuery Text-to-SQL Microservice, based on the PRD.

## Phase 1: Foundation (Week 1-2)

- [ ] **Task 1: Project Setup & FastAPI Framework**
  - [ ] Subtask 1.1: Initialize a Python 3.11 project.
  - [ ] Subtask 1.2: Install FastAPI, uvicorn, and other initial dependencies.
  - [ ] Subtask 1.3: Create the basic FastAPI application structure (`main.py`, routers, etc.).
  - [ ] Subtask 1.4: Implement the health check endpoint (`GET /api/v1/health`).
  - [ ] Subtask 1.5: Set up basic structured logging for the application.
- [ ] **Task 2: API Endpoint Design & Pydantic Models**
  - [ ] Subtask 2.1: Define Pydantic models for the request and response of `POST /api/v1/generate-sql`.
  - [ ] Subtask 2.2: Define Pydantic models for the request and response of `PUT /api/v1/schema`.
  - [ ] Subtask 2.3: Create stub implementations for these API endpoints in FastAPI.
- [ ] **Task 3: Schema Storage Design**
  - [ ] Subtask 3.1: Define the JSON format for storing schema information (tables, columns, relationships, descriptions, sample data) as per PRD sections 5.1 and 5.2.
  - [ ] Subtask 3.2: Select and configure an in-memory store with persistence (e.g., Redis).
- [ ] **Task 4: Qwen3 Container Communication Protocol**
  - [ ] Subtask 4.1: Define the exact request/response contract for communicating with the Qwen3 container (likely via Ollama).
  - [ ] Subtask 4.2: Draft a preliminary client module to send a test request to a (mocked) Qwen3 service.

## Phase 2: Core Functionality (Week 3-4)

- [ ] **Task 5: Schema Management Implementation**
  - [ ] Subtask 5.1: Implement the `PUT /api/v1/schema` endpoint logic:
    - [ ] Validate incoming schema data against the defined format.
    - [ ] Store/update schema components in the chosen storage solution (e.g., Redis).
  - [ ] Subtask 5.2: Implement functions to retrieve and format schema information for use in prompt engineering.
- [ ] **Task 6: Qwen3 Client Implementation**
  - [ ] Subtask 6.1: Develop the `Qwen3 Client` component to robustly communicate with the actual Qwen3 container using Ollama.
  - [ ] Subtask 6.2: Implement secure handling of connection details for the Qwen3 service (e.g., via environment variables).
- [ ] **Task 7: Prompt Engineering for Text-to-SQL**
  - [ ] Subtask 7.1: Design initial prompt templates incorporating:
    - [ ] Retrieved schema (tables, columns, data types).
    - [ ] Table and column descriptions.
    - [ ] Explicit relationships between tables.
    - [ ] Few-shot examples of natural language to BigQuery SQL conversions.
    - [ ] Chain-of-Thought prompting instructions.
    - [ ] Guidance on BigQuery-specific SQL syntax.
  - [ ] Subtask 7.2: Implement logic to dynamically construct these detailed prompts based on the user's natural language query and the available schema.
- [ ] **Task 8: Core `generate-sql` Endpoint Logic**
  - [ ] Subtask 8.1: Implement the main logic for the `POST /api/v1/generate-sql` endpoint:
    - [ ] Retrieve relevant schema information.
    - [ ] Construct the prompt using the prompt engineering module.
    - [ ] Send the prompt to the Qwen3 client and receive the response.
    - [ ] Extract the generated SQL query and any confidence score from the LLM's response.
- [ ] **Task 9: Initial SQL Validation**
  - [ ] Subtask 9.1: Implement basic syntax validation for the SQL generated by the LLM (e.g., using a Python SQL parsing library like `sqlparse`).
  - [ ] Subtask 9.2: Integrate this initial validation step into the `generate-sql` flow.

## Phase 3: Testing and Refinement (Week 5-6)

- [ ] **Task 10: Unit Testing Suite**
  - [ ] Subtask 10.1: Write unit tests for API endpoints, mocking dependencies like the LLM and schema store.
  - [ ] Subtask 10.2: Write unit tests for the schema management logic (storage, retrieval, validation).
  - [ ] Subtask 10.3: Write unit tests for the Qwen3 client, mocking Ollama/Qwen3 container responses.
  - [ ] Subtask 10.4: Write unit tests for SQL validation components.
  - [ ] Subtask 10.5: Write unit tests for error handling mechanisms across different components.
- [ ] **Task 11: Integration Testing Setup & Initial Dataset**
  - [ ] Subtask 11.1: Create an initial test dataset comprising pairs of (natural language query, expected BigQuery SQL output), covering various complexities and patterns.
  - [ ] Subtask 11.2: Set up a local or CI environment for end-to-end testing that includes the FastAPI service and a running Qwen3 container.
- [ ] **Task 12: Prompt Template Optimization & Advanced Text-to-SQL Techniques**
  - [ ] Subtask 12.1: Iteratively refine prompt templates based on results from initial testing to improve accuracy and adherence to BigQuery syntax.
  - [ ] Subtask 12.2: Research and experiment with implementing techniques inspired by the Spider benchmark and recent text-to-SQL papers (e.g., explicit schema linking, pattern-matching for common query templates).
  - [ ] Subtask 12.3: Explore implementing a simple error correction feedback loop: if SQL validation fails, re-prompt the LLM with the error information for self-correction.
- [ ] **Task 13: Advanced SQL Validation**
  - [ ] Subtask 13.1: Enhance SQL validation to check against the actual stored schema (e.g., verify that all referenced tables and columns exist in the schema).
  - [ ] Subtask 13.2: (Stretch Goal) Investigate using a BigQuery client library for more robust syntax validation or (simulated) query cost estimation, if feasible.
- [ ] **Task 14: Comprehensive Error Handling Implementation**
  - [ ] Subtask 14.1: Implement input validation for the `generate-sql` endpoint as per PRD section 8.1 (min/max length, token count, potential malicious inputs).
  - [ ] Subtask 14.2: Ensure schema existence checks before processing queries.
  - [ ] Subtask 14.3: Implement standardized error responses (HTTP status codes, consistent error codes, and user-friendly messages) as per PRD section 8.3.
- [ ] **Task 15: Monitoring and Logging Implementation**
  - [ ] Subtask 15.1: Implement detailed logging as specified in PRD section 11.1 (API requests/responses, processing times, LLM interaction details, token usage).
  - [ ] Subtask 15.2: Identify key metrics for monitoring (PRD section 11.2) and set up mechanisms to track them (e.g., exposing metrics for Prometheus, or enhancing structured logs for easier analysis).

## Phase 4: Deployment and Documentation (Week 7-8)

- [ ] **Task 16: Containerization of the API Service**
  - [ ] Subtask 16.1: Create a `Dockerfile` for the FastAPI application, using Python 3.11 as the base image and including all dependencies.
  - [ ] Subtask 16.2: Configure the container to accept environment variables for Qwen3 service connection details and other configurations.
  - [ ] Subtask 16.3: Build and thoroughly test the Docker container locally.
- [ ] **Task 17: Full Integration and Performance Testing**
  - [ ] Subtask 17.1: Execute end-to-end integration tests using the complete test dataset against the containerized service and Qwen3 container.
  - [ ] Subtask 17.2: Measure and document conversion accuracy and benchmark response times under various simulated load conditions.
- [ ] **Task 18: Documentation Creation**
  - [ ] Subtask 18.1: Generate and refine API documentation (utilizing FastAPI's auto-generated docs and supplementing with usage examples and explanations).
  - [ ] Subtask 18.2: Write comprehensive deployment documentation (instructions for running the container, required environment variables, dependencies on other services like Qwen3 and Redis).
  - [ ] Subtask 18.3: Prepare handover documentation covering architecture, key components, and maintenance guidelines.
- [ ] **Task 19: Final Review, Optimization, and Cleanup**
  - [ ] Subtask 19.1: Conduct thorough code reviews.
  - [ ] Subtask 19.2: Based on performance testing, identify and address any bottlenecks.
  - [ ] Subtask 19.3: Ensure all acceptance criteria from PRD section 13 are met.
  - [ ] Subtask 19.4: Clean up the codebase, remove any unused code/artifacts, and finalize all documentation.
